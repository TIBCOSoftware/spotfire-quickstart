---
#----------------------------------------
# Web Player (Windows) package install
#----------------------------------------
# Requires ansible.windows collection
# Install:
#  $ ansible-galaxy collection install ansible.windows
#

#- name: Get first tss server hostname
#  debug:
#    msg: "{{ hostvars[groups['tss_servers'][0]]['name'] | regex_replace('^(.*)-vm$', '\\1') }}"
#  register: tss_hostname
#

- set_fact:
    tss_hostname: "{{ hostvars[groups['tss_servers'][0]]['name'] | regex_replace('^(.*)-vm$', '\\1') }}"

- name: Show tss_hostname
  debug:
    msg: "{{ tss_hostname }}"

# https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_service_module.html
# Making install idempotent
- name: Windows | Check if the Spotfire node manager service is installed
  win_service:
    name: TIBCO Spotfire Node Manager {{ tss_version }}
    state: started
  register: nm_service
  changed_when: false # this is just a check, not showing changes here
  ignore_errors: yes

- debug:
    msg: "Windows | Is the Spotfire node manager service already installed? '{{ nm_service.exists }}'"

# https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_copy_module.html
- name: Windows | Copy Spotfire node manager windows package (nm.exe)
  win_copy:
    src: "{{ spotfire_local_sw_repo }}/nm-setup.exe"
    dest: C:\Users\{{ wp_user }}\nm-setup.exe
  tags: cp_package
  when: nm_service.exists is false

# https://docs.ansible.com/ansible/latest/collections/ansible/windows/win_command_module.html
- name: Windows | Install Spotfire node manager windows package (nm.exe)
  win_command: nm-setup.exe SERVER_NAME={{ tss_hostname }} -silent -log "C:\Users\{{ wp_user }}\nm-setup.log"
#    NODEMANAGER_REGISTRATION_PORT=9080
#    NODEMANAGER_COMMUNICATION_PORT=9443
#    SERVER_NAME={{ tss_host }}
#    SERVER_BACKEND_REGISTRATION_PORT=9080
#    SERVER_BACKEND_COMMUNICATION_PORT=9443
#    NODEMANAGER_HOST_NAMES={{ tss_host }}
#    NODEMANAGER_HOST=NodeManagerHost
#    -log "C:\Users\{{ wp_user }}\nm-install.log"
  args:
    chdir: C:\Users\{{ wp_user }}\
  tags: install_package
  when: nm_service.exists is false
